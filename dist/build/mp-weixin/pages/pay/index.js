(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/pay/index"],{"0244":function(e,t,n){"use strict";(function(e){n("6cdc");a(n("66fd"));var t=a(n("15fc"));function a(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},"15fc":function(e,t,n){"use strict";n.r(t);var a=n("ecf7"),s=n("bae4");for(var o in s)["default"].indexOf(o)<0&&function(e){n.d(t,e,(function(){return s[e]}))}(o);n("b191");var i,r=n("f0c5"),u=Object(r["a"])(s["default"],a["b"],a["c"],!1,null,"5a7ef5bd",null,!1,a["a"],i);t["default"]=u.exports},"2b62":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=u(n("a34a")),s=u(n("1087")),o=u(n("2c57")),i=u(n("081b")),r=u(n("6b82"));function u(e){return e&&e.__esModule?e:{default:e}}function c(e,t,n,a,s,o,i){try{var r=e[o](i),u=r.value}catch(c){return void n(c)}r.done?t(u):Promise.resolve(u).then(a,s)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(a,s){var o=e.apply(t,n);function i(e){c(o,a,s,i,r,"next",e)}function r(e){c(o,a,s,i,r,"throw",e)}i(void 0)}))}}var p=function(){Promise.all([n.e("common/vendor"),n.e("pages/pay/setPayPsw/index")]).then(function(){return resolve(n("b1f7"))}.bind(null,n)).catch(n.oe)},y=function(){Promise.all([n.e("common/vendor"),n.e("pages/pay/forgetPayPsw/index")]).then(function(){return resolve(n("4406"))}.bind(null,n)).catch(n.oe)},f=function(){n.e("pages/pay/passwordPopup/index").then(function(){return resolve(n("639e"))}.bind(null,n)).catch(n.oe)},h=function(){n.e("pages/pay/verificationCode/index").then(function(){return resolve(n("dcca"))}.bind(null,n)).catch(n.oe)},l=function(){n.e("pages/pay/cardList/index").then(function(){return resolve(n("ad7d"))}.bind(null,n)).catch(n.oe)},m={mixins:[r.default],data:function(){return{payInfo:{},payFlag:!1,submitParams:{payId:"",score:0,password:"",thirdPayAmount:0,thirdPayMethod:"alipay",cardAmount:0,balance:""},cardInfo:{},isWxFlag:!0,chooseTypeList:[],surplusMoney:0,oldBalance:0,wxCode:"",defaultTitleDto:{title:"收银台"}}},methods:{summary:function(){var t=this;s.default.summary(this.$Route.query.payId).then((function(n){200==n.data.code?(n.data.data.maxPkgPay<n.data.data.memberAsset.balance&&(n.data.data.memberAsset.balance=n.data.data.maxPkgPay),t.oldBalance=n.data.data.memberAsset.balance,t.payInfo=n.data.data,t.initChoose()):e.showToast({title:n.data.message,icon:"none"})}))},initChoose:function(){var e=this;return d(a.default.mark((function t(){return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.payInfo.payedSummary){t.next=14;break}if(!e.payInfo.memberAsset.balance){t.next=6;break}return e.chooseTypeList.push("账户余额"),e.$set(e.payInfo.memberAsset,"balanceUseMoney",e.payInfo.memberAsset.balance),t.next=6,e.defaultCards();case 6:if(!e.payInfo.memberAsset.cardAmount){t.next=11;break}return e.chooseTypeList.push("礼卡"),e.$set(e.payInfo.memberAsset,"cardUseMoney",e.payInfo.memberAsset.cardAmount),t.next=11,e.defaultCards();case 11:e.judegChooseOther(),t.next=16;break;case 14:e.surplusMoney=e.payInfo.needPay,e.judegChooseOther();case 16:case"end":return t.stop()}}),t)})))()},defaultCards:function(){var t=this;return d(a.default.mark((function n(){var o;return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o={balance:"-1"!=t.chooseTypeList.indexOf("账户余额")?t.payInfo.memberAsset.balanceUseMoney:0,payId:t.$Route.query.payId,cardAmount:"-1"!=t.chooseTypeList.indexOf("礼卡")?t.payInfo.memberAsset.cardUseMoney:0},n.next=3,s.default.defaultCards(o).then((function(n){200==n.data.code?(t.cardInfo=n.data.data,t.$set(t.payInfo.memberAsset,"cardAmount",n.data.data.usefulAmount)):e.showToast({title:n.data.message,icon:"none"})}));case 3:case"end":return n.stop()}}),n)})))()},judgeSurplusMoney:function(){for(var e=0,t=0;t<this.chooseTypeList.length;t++)switch(this.chooseTypeList[t]){case"账户余额":e+=this.payInfo.memberAsset.balanceUseMoney;break;case"礼卡":e+=this.payInfo.memberAsset.cardUseMoney;break}return this.payInfo.payedSummary||(this.surplusMoney=this.payInfo.orderAmount-e),this.surplusMoney},judegChooseOther:function(){this.isWxFlag&&(-1!=this.judgeTypeIsExistence("微信")&&this.judgeSurplusMoney()<=0?this.chooseTypeList.splice(this.judgeTypeIsExistence("微信"),1):this.judgeSurplusMoney()>0&&-1==this.judgeTypeIsExistence("微信")&&this.chooseTypeList.push("微信"))},accountChange:function(){var e=this;return d(a.default.mark((function t(){return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return-1!=e.judgeTypeIsExistence("账户余额")?(e.chooseTypeList.splice(e.judgeTypeIsExistence("账户余额"),1),e.payInfo.memberAsset.balanceUseMoney=0):(e.chooseTypeList.push("账户余额"),e.payInfo.memberAsset.balanceUseMoney=e.payInfo.memberAsset.balance),t.next=3,e.defaultCards();case 3:e.judegChooseOther(),-1==e.judgeTypeIsExistence("账户余额")&&(e.payInfo.memberAsset.cardUseMoney?e.payInfo.memberAsset.balance=e.surplusMoney<e.oldBalance?e.surplusMoney:e.oldBalance:e.payInfo.memberAsset.balance=e.oldBalance);case 5:case"end":return t.stop()}}),t)})))()},giftChange:function(){var e=this;return d(a.default.mark((function t(){return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return-1!=e.judgeTypeIsExistence("礼卡")?(e.chooseTypeList.splice(e.judgeTypeIsExistence("礼卡"),1),e.payInfo.memberAsset.cardUseMoney=0):(e.chooseTypeList.push("礼卡"),e.payInfo.memberAsset.cardUseMoney=e.payInfo.memberAsset.cardAmount),t.next=3,e.defaultCards();case 3:e.judegChooseOther(),-1==e.judgeTypeIsExistence("账户余额")&&(e.payInfo.memberAsset.balance=e.oldBalance-e.surplusMoney>0?e.surplusMoney:e.oldBalance);case 5:case"end":return t.stop()}}),t)})))()},outsideStationChange:function(e){var t=this.judgeTypeIsExistence(e);"-1"!=t&&2==this.judgeIsExistence()&&("微信"==e?this.chooseTypeList.splice(t,1,"支付宝"):this.chooseTypeList.splice(t,1,"微信"))},cardAmountChange:function(e){this.cardInfo=e,this.$set(this.payInfo.memberAsset,"cardUseMoney",e.selectedAmount),-1==this.judgeTypeIsExistence("礼卡")?this.chooseTypeList.push("礼卡"):this.payInfo.memberAsset.cardUseMoney||-1==this.judgeTypeIsExistence("礼卡")||this.chooseTypeList.splice(this.judgeTypeIsExistence("礼卡"),1),this.judegChooseOther(),this.payInfo.memberAsset.balance=this.oldBalance-this.surplusMoney>0?this.surplusMoney:this.oldBalance},judgeTypeIsExistence:function(e){var t=this.chooseTypeList.findIndex((function(t){return t==e}));return t},judgeIsExistence:function(){var e=0;return this.isWxFlag&&e++,e},openPswPopup:function(){var t=this;this.payInfo.orderSummary.scorePayedAmount||"-1"!=this.judgeTypeIsExistence("礼卡")||"-1"!=this.judgeTypeIsExistence("账户余额")?(console.log(this.payInfo),this.payInfo.riskCheck&&"MID"==this.payInfo.riskCheck.riskLevel||this.payInfo.riskCheck&&"LOW"==this.payInfo.riskCheck.riskLevel&&this.payInfo.riskCheck.firstAddrMobile&&!this.payInfo.riskCheck.monthNewMember&&this.payInfo.riskCheck&&this.payInfo.riskCheck.unsafeAmt<this.payInfo.memberAsset.cardUseMoney+this.payInfo.memberAsset.scorePayedAmount+this.payInfo.memberAsset.balanceUseMoney?this.$refs.verificationCode.openVerificationCode():this.payInfo.hasPayPwd?this.$refs.pswPopup.openPswPopup():this.$refs.setPayPwd.openNoPswPopup()):e.login({success:function(e){t.buildMiniPrepPaySign(e.code)}})},buildMiniPrepPaySign:function(t,n){var a=this,s="good";this.$Route.query.increase?s="giftbag":this.$Route.query.newtype>50&&(s="newtype"),o.default.buildMiniPrepPaySign({code:t,orderPayId:n||this.$Route.query.payId,orderType:s}).then((function(t){200==t.data.code?a.requestpayment(t.data.data):e.showToast({title:t.data.message,icon:"none"})}))},buildPrepPaySign:function(){var t=this;o.default.buildPrepPaySign({code:this.wxCode,orderPayId:this.$Route.query.payId,orderType:"good"}).then((function(n){200==n.data.code?t.requestH5Payment(n.data.data):e.showToast({title:n.data.message,icon:"none"})}))},requestpayment:function(t){var n=this;e.requestPayment({provider:"payment",timeStamp:t.timeStamp,nonceStr:t.nonceStr,package:t.package,paySign:t.paySign,signType:t.signType,success:function(e){n.payCallBack(!0)},fail:function(e){n.payCallBack(!1)}})},requestH5Payment:function(e){"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",this.WeixinJSBridgeH5,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",this.WeixinJSBridgeH5),document.attachEvent("onWeixinJSBridgeReady",this.WeixinJSBridgeH5)):this.WeixinJSBridgeH5(e)},WeixinJSBridgeH5:function(e){var t=this;WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appId,timeStamp:e.timeStamp,nonceStr:e.nonceStr,package:e.package,signType:e.signType,paySign:e.paySign},(function(e){"get_brand_wcpay_request:ok"==e.err_msg?t.payCallBack(!0):(e.err_msg,t.payCallBack(!1))}))},payCallBack:function(t){var n=this;t?(e.showToast({title:"支付成功",icon:"none"}),this.$Router.replace({path:"/pages/payment/index",query:{payId:this.$Route.query.payId,newtype:this.$Route.query.newtype,increase:this.$Route.query.increase||""}})):(e.showToast({title:"已取消支付,正在前往订单页",icon:"none"}),setTimeout((function(){n.$Router.replace({path:"/pages/order/index"})}),500))},getH5Code:function(){var t=this;i.default.wxPubAppId().then((function(n){if(200==n.data.code){var a="https://"+location.host+location.pathname+"?payId="+t.$Route.query.payId;location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+n.data.data+"&redirect_uri="+encodeURIComponent(a)+"&response_type=code&scope=snsapi_userinfo"}else e.showToast({title:n.data.message,icon:"none"})}))},openForgetPopup:function(){this.$refs.forgetPayPsw.openForgetPopup()},setSubmitPsw:function(e){this.submitParams.password=e,this.submit()},codeSubmit:function(e){this.$set(this.submitParams,"code",e),this.submit()},submit:function(){var t=this;this.submitParams={balance:this.payInfo.memberAsset.balanceUseMoney?this.payInfo.memberAsset.balanceUseMoney:0,password:this.submitParams.password,payId:this.$Route.query.payId,score:this.payInfo.orderSummary.scorePayedAmount,thirdPayAmount:Number(this.surplusMoney).toFixed(2),thirdPayMethod:"1"!=this.chooseTypeList.indexOf("支付宝")?"alipay":"wxpay",code:this.submitParams.code,cardAmount:this.payInfo.memberAsset.cardUseMoney?this.payInfo.memberAsset.cardUseMoney:0},s.default.submitPay(this.submitParams).then((function(n){if(200==n.data.code){if(t.$refs.verificationCode.closeVerificationCode(),"-1"!=t.judgeTypeIsExistence("微信"))return e.showLoading({title:"正在前往微信支付",mask:!1}),void e.login({success:function(e){t.buildMiniPrepPaySign(e.code,n.data.data)}});t.payCallBack(!0)}else e.showToast({title:n.data.message,icon:"none"})}))},openGiftCardPopup:function(){this.cardInfo.usableCards&&this.cardInfo.usableCards.length&&this.$refs.giftCard.openGiftCardPopup()}},onLoad:function(e){this.isWxFlag=1,this.fmagentInit(),this.submitParams.payId=this.$Route.query.payId,this.summary(),e.code&&(this.wxCode=e.code,this.buildPrepPaySign())},onShow:function(){this.zhuge.track("订单收银台-落地页")},components:{setPayPwd:p,forgetPayPsw:y,pswPopup:f,verificationCode:h,cardList:l}};t.default=m}).call(this,n("543d")["default"])},"49c8":function(e,t,n){},b191:function(e,t,n){"use strict";var a=n("49c8"),s=n.n(a);s.a},bae4:function(e,t,n){"use strict";n.r(t);var a=n("2b62"),s=n.n(a);for(var o in a)["default"].indexOf(o)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(o);t["default"]=s.a},ecf7:function(e,t,n){"use strict";var a;n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return a}));var s=function(){var e=this,t=e.$createElement,n=(e._self._c,e.payInfo.payedSummary?null:e.chooseTypeList.indexOf("账户余额")),a=e.payInfo.payedSummary?null:e.chooseTypeList.indexOf("账户余额"),s=e.payInfo.memberAsset&&!e.payInfo.payedSummary?e.chooseTypeList.indexOf("礼卡"):null,o=!e.payInfo.memberAsset||e.payInfo.payedSummary||this.payInfo.payedSummary?null:e.chooseTypeList.indexOf("礼卡"),i=e.isWxFlag?e.chooseTypeList.indexOf("微信"):null,r=e.isWxFlag&&"-1"!=i?Number(e.surplusMoney).toFixed(2):null,u=e.isWxFlag?e.chooseTypeList.indexOf("微信"):null;e._isMounted||(e.e0=function(t){e.payFlag=!e.payFlag}),e.$mp.data=Object.assign({},{$root:{g0:n,g1:a,g2:s,g3:o,g4:i,g5:r,g6:u}})},o=[]}},[["0244","common/runtime","common/vendor"]]]);